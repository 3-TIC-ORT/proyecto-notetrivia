<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Editor estilo Google Docs</title>

<!-- Opcional: fuente m√°s linda -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<style>
:root {
--bg: #f3f4f8;
--border-subtle: #dadce0;
--border-strong: #c3c6d4;
--toolbar-bg: #ffffff;
--accent: #1a73e8;
--accent-soft: #e8f0fe;
--text-main: #202124;
--text-muted: #5f6368;
}

* {
box-sizing: border-box;
}

body {
margin: 0;
font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
background: radial-gradient(circle at top left, #e3f2fd 0, #f3f4f8 40%, #f3f4f8 100%);
color: var(--text-main);
}

.app-shell {
min-height: 100vh;
display: flex;
flex-direction: column;
}

/* TOPBAR estilo Google Docs */
.topbar {
display: flex;
align-items: center;
justify-content: space-between;
padding: 8px 16px;
border-bottom: 1px solid var(--border-subtle);
background: #ffffffcc;
backdrop-filter: blur(10px);
position: sticky;
top: 0;
z-index: 20;
}

.brand {
display: flex;
align-items: center;
gap: 10px;
}

.brand-logo {
width: 32px;
height: 32px;
border-radius: 8px;
display: flex;
align-items: center;
justify-content: center;

}

.brand-text {
display: flex;
flex-direction: column;
}

.brand-title {
font-size: 15px;
font-weight: 600;
}

.brand-subtitle {
font-size: 12px;
color: var(--text-muted);
}

.topbar-actions {
display: flex;
align-items: center;
gap: 8px;
}

.topbar-btn {
border-radius: 16px;
padding: 6px 14px;
border: 1px solid transparent;
background: var(--accent);
color: white;
font-size: 13px;
font-weight: 500;
cursor: pointer;
display: inline-flex;
align-items: center;
gap: 6px;
box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
transition: background 0.15s ease, box-shadow 0.15s ease, transform 0.05s ease;
}

.topbar-btn:hover {
background: #1557b0;
box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
transform: translateY(-1px);
}

.topbar-avatar {
width: 28px;
height: 28px;
border-radius: 999px;
border: 1px solid var(--border-subtle);
background: #fff;
display: flex;
align-items: center;
justify-content: center;
font-size: 14px;
font-weight: 600;
color: var(--accent);
cursor: pointer;
}

/* TOOLBARS */
.toolbar-wrapper {
position: sticky;
top: 48px;
z-index: 15;
background: transparent;
}

.toolbar {
display: flex;
align-items: center;
gap: 10px;
padding: 6px 16px;
background: var(--toolbar-bg);
border-bottom: 1px solid var(--border-subtle);
}

.toolbar + .toolbar {
border-top: none;
}

.toolbar-group {
display: inline-flex;
align-items: center;
gap: 4px;
padding-right: 10px;
margin-right: 10px;
border-right: 1px solid var(--border-subtle);
}

.toolbar-group:last-child {
border-right: none;
margin-right: 0;
padding-right: 0;
}

.toolbar button,
.toolbar select,
.toolbar .color-picker-label {
border-radius: 4px;
border: 1px solid transparent;
background: transparent;
padding: 4px 6px;
font-size: 13px;
cursor: pointer;
color: var(--text-main);
display: inline-flex;
align-items: center;
gap: 4px;
min-height: 26px;
}

.toolbar button:hover,
.toolbar select:hover,
.toolbar .color-picker-label:hover {
background: #f1f3f4;
border-color: var(--border-subtle);
}

.toolbar button.active {
background: var(--accent-soft);
border-color: var(--accent);
color: var(--accent);
}

.toolbar select {
padding-right: 18px;
background: #fff;
border-color: var(--border-subtle);
}

.toolbar-icon {
font-size: 14px;
}

.toolbar button b,
.toolbar button i,
.toolbar button u,
.toolbar button s,
.toolbar button code {
font-size: 14px;
}

.color-picker-label {
position: relative;
padding-right: 4px;
}

.color-sample {
width: 14px;
height: 3px;
border-radius: 999px;
background: #000000;
margin-top: 2px;
}

.color-input {
position: absolute;
inset: 0;
opacity: 0;
cursor: pointer;
}

/* EDITOR WRAPPER / "HOJA" */
.editor-wrapper {
flex: 1;
padding: 24px 0 40px;
display: flex;
justify-content: center;
}

.page-shadow {
width: min(900px, 100% - 32px);
background: transparent;
display: flex;
justify-content: center;
}

.tiptap {
width: 100%;
max-width: 800px;
min-height: 900px;
margin: 0 auto;
padding: 40px 56px;
background: #ffffff;
border-radius: 10px;
border: 1px solid var(--border-subtle);
box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
outline: none;
}

/* Contenido TipTap default styles */
.tiptap:focus {
border-color: var(--accent);
box-shadow: 0 0 0 1px var(--accent-soft), 0 8px 24px rgba(0, 0, 0, 0.1);
}

.tiptap p {
margin: 0 0 0.5em;
line-height: 1.6;
font-size: 15px;
}

.tiptap h1 {
font-size: 28px;
margin: 0.8em 0 0.4em;
font-weight: 700;
}

.tiptap h2 {
font-size: 22px;
margin: 0.8em 0 0.4em;
font-weight: 600;
}

.tiptap h3 {
font-size: 18px;
margin: 0.8em 0 0.4em;
font-weight: 600;
}

.tiptap ul,
.tiptap ol {
padding-left: 1.5em;
margin: 0.4em 0;
}

.tiptap blockquote {
border-left: 3px solid var(--border-strong);
margin: 0.8em 0;
padding-left: 0.8em;
color: var(--text-muted);
font-style: italic;
}

.tiptap code {
background: #f1f3f4;
padding: 2px 4px;
border-radius: 4px;
font-family: "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
font-size: 13px;
}

.tiptap pre {
background: #111827;
color: #e5e7eb;
padding: 10px 12px;
border-radius: 6px;
overflow-x: auto;
font-size: 13px;
}

.tiptap hr {
border: none;
border-top: 1px solid var(--border-subtle);
margin: 16px 0;
}

.tiptap a {
color: var(--accent);
text-decoration: underline;
}

.tiptap mark {
background: #fff59d;
padding: 0 2px;
}

@media (max-width: 800px) {
.tiptap {
padding: 24px 18px;
min-height: 600px;
}

.toolbar {
flex-wrap: wrap;
}

.toolbar-group {
border-right: none;
padding-right: 0;
margin-right: 4px;
}
}

/* BOT√ìN QUIZ FLOTANTE */
.quiz-button {
position: fixed;
bottom: 30px;
right: 30px;
background: linear-gradient(135deg, #ff6b9d 0%, #ff8fab 100%);
color: white;
border: none;
border-radius: 25px;
padding: 12px 28px;
font-size: 16px;
font-weight: 600;
cursor: pointer;
box-shadow: 0 4px 15px rgba(255, 107, 157, 0.4);
transition: all 0.3s ease;
z-index: 1000;
}

.quiz-button:hover {
transform: translateY(-2px);
box-shadow: 0 6px 20px rgba(255, 107, 157, 0.6);
}

/* VENTANA FLOTANTE DEL QUIZ */
.quiz-overlay {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.5);
z-index: 2000;
justify-content: center;
align-items: center;
}

.quiz-overlay.active {
display: flex;
}

.quiz-container {
background: white;
border-radius: 20px;
padding: 40px;
max-width: 800px;
width: 90%;
box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
animation: slideIn 0.3s ease;
}

@keyframes slideIn {
from {
transform: translateY(-50px);
opacity: 0;
}
to {
transform: translateY(0);
opacity: 1;
}
}

.quiz-header {
background: linear-gradient(135deg, #5fcad8 0%, #4fb3c1 100%);
border-radius: 12px;
padding: 40px;
margin-bottom: 30px;
text-align: center;
}

.quiz-question {
font-size: 24px;
font-weight: 600;
color: #202124;
margin: 0;
}

.quiz-options {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 15px;
margin-bottom: 20px;
}

.quiz-option {
background: linear-gradient(135deg, #ff8fab 0%, #ff9eb8 100%);
color: white;
border: none;
border-radius: 12px;
padding: 20px;
font-size: 16px;
font-weight: 500;
cursor: pointer;
transition: all 0.3s ease;
text-align: center;
box-shadow: 0 2px 8px rgba(255, 143, 171, 0.3);
}

.quiz-option:hover {
transform: translateY(-3px);
box-shadow: 0 4px 12px rgba(255, 143, 171, 0.5);
}

.quiz-option.correct {
background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
}

.quiz-option.incorrect {
background: linear-gradient(135deg, #f44336 0%, #e57373 100%);
}

.quiz-option.disabled {
cursor: not-allowed;
opacity: 0.7;
}

.quiz-actions {
display: flex;
justify-content: space-between;
align-items: center;
margin-top: 25px;
}

.quiz-close {
background: #e0e0e0;
color: #202124;
border: none;
border-radius: 20px;
padding: 10px 24px;
font-size: 14px;
font-weight: 600;
cursor: pointer;
transition: all 0.2s ease;
}

.quiz-close:hover {
background: #bdbdbd;
}

.quiz-next {
background: linear-gradient(135deg, #ff6b9d 0%, #ff8fab 100%);
color: white;
border: none;
border-radius: 20px;
padding: 10px 24px;
font-size: 14px;
font-weight: 600;
cursor: pointer;
transition: all 0.2s ease;
box-shadow: 0 2px 8px rgba(255, 107, 157, 0.3);
}

.quiz-next:hover {
transform: translateY(-1px);
box-shadow: 0 4px 12px rgba(255, 107, 157, 0.5);
}

.quiz-counter {
font-size: 14px;
color: #5f6368;
font-weight: 500;
}

.quiz-score {
text-align: center;
margin-top: 20px;
}

.quiz-score h2 {
color: var(--accent);
font-size: 28px;
margin-bottom: 10px;
}

.quiz-score p {
font-size: 16px;
color: var(--text-muted);
}
</style>
</head>
<body>
<div class="app-shell">
<header class="topbar">
<div class="brand">
<img src="../IMGS/isotipo.png" class="brand-logo" alt="">
<div class="brand-text">
<div class="brand-title" id="ROOMname"></div>
<div class="brand-subtitle" id="usuario"></div>
</div>
</div>
<div class="topbar-actions">
<button class="topbar-btn">
<span class="toolbar-icon">üì§</span>
Compartir
</button>
<div class="topbar-avatar">D</div>
</div>
</header>

<div class="toolbar-wrapper">
<!-- FILA 1: estilos de texto -->
<div class="toolbar">
<div class="toolbar-group">
<select id="heading-select">
<option value="paragraph">Normal</option>
<option value="h1">T√≠tulo 1</option>
<option value="h2">T√≠tulo 2</option>
<option value="h3">T√≠tulo 3</option>
</select>
</div>

<div class="toolbar-group">
<button type="button" data-action="toggleBold" title="Negrita (Ctrl+B)"><b>B</b></button>
<button type="button" data-action="toggleItalic" title="Cursiva (Ctrl+I)"><i>I</i></button>
<button type="button" data-action="toggleUnderline" title="Subrayado (Ctrl+U)"><u>U</u></button>
<button type="button" data-action="toggleStrike" title="Tachado"><s>S</s></button>
<button type="button" data-action="toggleHighlight" title="Resaltado"><mark>A</mark></button>
</div>

<div class="toolbar-group">
<label class="color-picker-label" title="Color de texto">
<span class="toolbar-icon">A</span>
<div class="color-sample" id="color-sample"></div>
<input id="color-input" class="color-input" type="color" value="#202124" />
</label>
</div>

<div class="toolbar-group">
<button type="button" data-action="toggleBulletList" title="Lista con vi√±etas">‚Ä¢ Lista</button>
<button type="button" data-action="toggleOrderedList" title="Lista numerada">1. Lista</button>
</div>

<div class="toolbar-group">
<button type="button" data-action="setTextAlign" data-align="left" title="Alinear a la izquierda">‚¨ÖÔ∏è</button>
<button type="button" data-action="setTextAlign" data-align="center" title="Centrar">‚ÜîÔ∏è</button>
<button type="button" data-action="setTextAlign" data-align="right" title="Alinear a la derecha">‚û°Ô∏è</button>
<button type="button" data-action="setTextAlign" data-align="justify" title="Justificar">‚ò∞</button>
</div>
</div>

<!-- FILA 2: estructura y utilidades -->
<div class="toolbar">
<div class="toolbar-group">
<button type="button" data-action="toggleBlockquote" title="Cita">‚ùù ‚ùû</button>
<button type="button" data-action="toggleCode" title="C√≥digo inline"><code>{ }</code></button>
<button type="button" data-action="toggleCodeBlock" title="Bloque de c√≥digo">&lt;/&gt;</button>
<button type="button" data-action="setHorizontalRule" title="Separador">‚îÄ</button>
</div>

<div class="toolbar-group">
<button type="button" data-action="undo" title="Deshacer (Ctrl+Z)">‚Ü©Ô∏è</button>
<button type="button" data-action="redo" title="Rehacer (Ctrl+Y)">‚Ü™Ô∏è</button>
<button type="button" data-action="clearFormatting" title="Quitar formato">üßπ</button>
</div>
</div>
</div>

<main class="editor-wrapper">
<div class="page-shadow">
<div class="tiptap"></div>
</div>
</main>

<!-- BOT√ìN QUIZ -->
<button class="quiz-button" id="botonquiz">quiz</button>

<!-- VENTANA FLOTANTE DEL QUIZ -->
<div class="quiz-overlay" id="quizOverlay">
<div class="quiz-container">
<div class="quiz-header">
<p class="quiz-question" id="quizQuestion">pregunta</p>
</div>
<div class="quiz-options" id="quizOptions">
<button class="quiz-option">Opcion 1</button>
<button class="quiz-option">Opcion 2</button>
<button class="quiz-option">Opcion 3</button>
<button class="quiz-option">Opcion 4</button>
</div>
<div class="quiz-actions">
<button class="quiz-close" onclick="closeQuiz()">Cerrar</button>
<div class="quiz-counter" id="quizCounter">1 / 5</div>
<button class="quiz-next" id="quizNext" onclick="nextQuestion()">Siguiente</button>
</div>
<div class="quiz-score" id="quizScore" style="display: none;"></div>
</div>
</div>
</div>

<script type="module">
import { Editor } from "https://esm.sh/@tiptap/core";
import StarterKit from "https://esm.sh/@tiptap/starter-kit";
import Underline from "https://esm.sh/@tiptap/extension-underline";
import Strike from "https://esm.sh/@tiptap/extension-strike";
import Highlight from "https://esm.sh/@tiptap/extension-highlight";
import Color from "https://esm.sh/@tiptap/extension-color";
import TextAlign from "https://esm.sh/@tiptap/extension-text-align";

const headingSelect = document.querySelector('#heading-select');
const colorInput = document.querySelector('#color-input');
const colorSample = document.querySelector('#color-sample');

const editor = new Editor({
element: document.querySelector('.tiptap'),
extensions: [
StarterKit.configure({
heading: {
levels: [1, 2, 3],
},
}),
Underline,
Strike,
Highlight,
Color,
TextAlign.configure({
types: ['heading', 'paragraph'],
}),
],
autofocus: true,
onUpdate: () => updateToolbar(),
onSelectionUpdate: () => updateToolbar(),
});

const actionToNodeOrMark = {
toggleBold: 'bold',
toggleItalic: 'italic',
toggleUnderline: 'underline',
toggleStrike: 'strike',
toggleHighlight: 'highlight',
toggleCode: 'code',
toggleCodeBlock: 'codeBlock',
toggleBlockquote: 'blockquote',
toggleBulletList: 'bulletList',
toggleOrderedList: 'orderedList',
};

// Acciones de los botones
document.querySelectorAll('.toolbar button').forEach((btn) => {
btn.addEventListener('click', () => {
const action = btn.dataset.action;

if (!action) return;

// Alineaci√≥n de texto
if (action === 'setTextAlign') {
const align = btn.dataset.align;
editor.chain().focus().setTextAlign(align).run();
updateToolbar();
return;
}

// Separador horizontal
if (action === 'setHorizontalRule') {
editor.chain().focus().setHorizontalRule().run();
updateToolbar();
return;
}

// Limpiar formato
if (action === 'clearFormatting') {
editor
.chain()
.focus()
.clearNodes()
.unsetAllMarks()
.unsetTextAlign()
.run();
updateToolbar();
return;
}

// Resto de acciones (las que existen en TipTap)
const chain = editor.chain().focus();
if (typeof chain[action] === 'function') {
chain[action]().run();
}

updateToolbar();
});
});

// Selector de t√≠tulos
headingSelect.addEventListener('change', (e) => {
const value = e.target.value;

if (value === 'paragraph') {
editor.chain().focus().setParagraph().run();
} else {
const level = parseInt(value[1], 10);
editor.chain().focus().toggleHeading({ level }).run();
}

updateToolbar();
});

// Color de texto
colorInput.addEventListener('input', (e) => {
const value = e.target.value;
colorSample.style.backgroundColor = value;
editor.chain().focus().setColor(value).run();
updateToolbar();
});

function syncColorSample() {
const attrs = editor.getAttributes('textStyle');
const currentColor = attrs?.color || '#202124';
colorSample.style.backgroundColor = currentColor;
colorInput.value = currentColor;
}

// Actualizar estado visual de la barra
function updateToolbar() {
document.querySelectorAll('.toolbar button').forEach((btn) => {
const action = btn.dataset.action;
let active = false;

if (!action) return;

if (action === 'setTextAlign') {
const align = btn.dataset.align;
active = editor.isActive({ textAlign: align });
} else if (actionToNodeOrMark[action]) {
active = editor.isActive(actionToNodeOrMark[action]);
}

btn.classList.toggle('active', active);
});

// Select de headings
if (editor.isActive('heading', { level: 1 })) {
headingSelect.value = 'h1';
} else if (editor.isActive('heading', { level: 2 })) {
headingSelect.value = 'h2';
} else if (editor.isActive('heading', { level: 3 })) {
headingSelect.value = 'h3';
} else {
headingSelect.value = 'paragraph';
}

    syncColorSample();
}

// Asignar editor globalmente
window.tiptapEditor = editor;

// Inicializar barra
updateToolbar();

const socket = io("http://localhost:3000");

// Hacer socket accesible globalmente para el quiz
window.appSocket = socket;

// Esperar a que el editor est√© completamente listo
setTimeout(() => {
    const editorr = window.tiptapEditor;
    const roomMUESTRA = document.getElementById("ROOMname");

    const docId = localStorage.getItem("docId");
    const user = localStorage.getItem("userDEV");

    if (!docId || !user) {
        alert("Faltan datos, redirigiendo...");
        window.location.href = "index.html";
    }

    roomMUESTRA.textContent = docId;
    document.getElementById("usuario").textContent = user;

    let updatingFromServer = false;

    let lastContent = "";

    socket.emit("unirse", { docId, user });
    console.log("Solicitando documento:", docId);

    socket.on("loadDocument", (content) => {
        console.log("Recibiendo loadDocument");
        updatingFromServer = true;
        
        // Solo actualizar si el contenido es diferente
        if (content !== lastContent) {
            editorr.commands.setContent(content || "");
            lastContent = content || "";
        }
        
        setTimeout(() => {
            updatingFromServer = false;
        }, 50);
    });
    
    socket.on("updateDocument", (newContent) => {
        console.log("Recibiendo updateDocument");
        updatingFromServer = true;
        
        // Solo actualizar si el contenido es diferente
        if (newContent !== lastContent) {
            editorr.commands.setContent(newContent || "");
            lastContent = newContent || "";
        }
        
        setTimeout(() => {
            updatingFromServer = false;
        }, 50);
    });

    editorr.on("update", () => {
        if (updatingFromServer) {
            console.log("Ignorando update porque viene del servidor");
            return;
        }

        const html = editorr.getHTML();

        if (html === lastContent) {
            console.log("Contenido igual, no se env√≠a");
            return;
        }

        console.log("Enviando cambio al servidor");
        lastContent = html; 

        socket.emit("editDocument", {
            docId,
            user,
            content: html
        });
    });
}, 100);

function getSelectedText() {
  const { from, to } = editor.state.selection;
  return editor.state.doc.textBetween(from, to, "\n");
}
// ============ FUNCIONALIDAD DEL QUIZ ============
    let botonquiz = document.getElementById("botonquiz");


   botonquiz.addEventListener("click", () => {
    const seleccionado = getSelectedText();
    if (!seleccionado || seleccionado.trim() === "") {
        alert("Por favor, selecciona un texto para generar el quiz.");
        return;
    } 
    else if (seleccionado.trim().length < 20) {
        alert("Por favor, selecciona un texto m√°s largo para generar el quiz.");
        return;
    }
    else {
    socket.emit("generartrivia", seleccionado);
    }
   });

    // Escuchar trivia generada
   socket.on("trivia-generada", (data) => {
       console.log("Trivia generada:", data);
    });






</script>

</body>
</html>